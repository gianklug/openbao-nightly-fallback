name: OpenBao Nightly Build

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      openbao_ref:
        description: 'OpenBao branch/tag/commit to build (default: main)'
        required: false
        default: 'main'
        type: string

env:
  OPENBAO_REPO: 'https://github.com/openbao/openbao.git'
  GO_VERSION: '1.23'

jobs:
  build-and-release:
    name: Build OpenBao Nightly
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git

      - name: Clone OpenBao repository
        run: |
          git clone ${{ env.OPENBAO_REPO }} openbao-source
          cd openbao-source

          # Check out the specified ref or default to main
          if [ -n "${{ github.event.inputs.openbao_ref }}" ]; then
            git checkout ${{ github.event.inputs.openbao_ref }}
          fi

          echo "Building OpenBao from commit: $(git rev-parse HEAD)"
          echo "OPENBAO_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "OPENBAO_SHORT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Set version and date
        run: |
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "NIGHTLY_VERSION=nightly-$(date -u +%Y%m%d)" >> $GITHUB_ENV

      - name: Install Node.js for UI build
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build OpenBao binaries
        working-directory: openbao-source
        run: |
          # Install dependencies
          go mod download

          # Run bootstrap to get build tools
          make bootstrap || true

          # Build UI assets
          make static-dist

          # Build the binary with UI
          CGO_ENABLED=0 BUILD_TAGS='ui' sh -c "'$(pwd)/scripts/build.sh'"

          # Create release directory
          mkdir -p ../release

          # Copy built binary
          if [ -f bin/bao ]; then
            cp bin/bao ../release/bao-linux-amd64
          else
            echo "Binary not found in expected location"
            find . -name bao -type f
            exit 1
          fi

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # OpenBao Nightly Build - ${{ env.NIGHTLY_VERSION }}

          **Build Date:** ${{ env.BUILD_DATE }}
          **Source Commit:** ${{ env.OPENBAO_COMMIT }}

          Automated nightly build from https://github.com/openbao/openbao

          Includes Web UI.

          ## Installation

          ```bash
          chmod +x bao-linux-amd64
          sudo mv bao-linux-amd64 /usr/local/bin/bao
          bao version
          ```

          ⚠️ Nightly build - use at your own risk
          EOF

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Delete old nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Delete the nightly tag and release if it exists
          gh release delete nightly --yes --cleanup-tag || true
        continue-on-error: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create nightly \
            --title "OpenBao Nightly Build - ${{ env.NIGHTLY_VERSION }}" \
            --notes-file release-notes.md \
            --prerelease \
            release/*

      - name: Update latest nightly info
        run: |
          mkdir -p nightly-info
          cat > nightly-info/latest.json << EOF
          {
            "version": "${{ env.NIGHTLY_VERSION }}",
            "build_date": "${{ env.BUILD_DATE }}",
            "commit": "${{ env.OPENBAO_COMMIT }}",
            "short_commit": "${{ env.OPENBAO_SHORT_COMMIT }}",
            "source_repo": "https://github.com/openbao/openbao"
          }
          EOF

          cat > nightly-info/README.md << EOF
          # Latest Nightly Build

          **Version:** ${{ env.NIGHTLY_VERSION }}
          **Built:** ${{ env.BUILD_DATE }}
          **Commit:** ${{ env.OPENBAO_SHORT_COMMIT }}

          [Download Latest Nightly Release](https://github.com/${{ github.repository }}/releases/tag/nightly)
          EOF

      - name: Commit nightly info
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add nightly-info/
          git diff --staged --quiet || git commit -m "Update nightly build info - ${{ env.NIGHTLY_VERSION }}"
          git push || true
        continue-on-error: true
